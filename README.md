# csv_builder
A PL/SQL package that generates CSV data.

## Install
The project consists of a single package. To install, from `sqlcl` or another
Oracle client:
```
@install.sql
```
The installing user needs to be able to grant execute on the `DBMS_SQL` package.

## Usage
The simplest case is to pass a query as a string to the `query_to_sql` function:
```sql
declare
    l_csv                               clob;
    l_query                             varchar2(4000);
begin
    l_query := 
        q'[select c.cust_id, c.cust_first_name, c.cust_last_name, c.cust_eff_from
             from sh.customers c
            fetch first 5 rows only]';
    l_csv := csv_builder.query_to_csv(
        p_query => l_query
    );
    dbms_output.put_line( l_csv );
end;
```
```
"CUST_ID","CUST_FIRST_NAME","CUST_LAST_NAME","CUST_EFF_FROM"
13350,"Idette","Berry","01/01/98"
16905,"Idette","Berry","01/01/98"
20460,"Idette","Berry","01/01/98"
24016,"Idette","Berry","01/01/98"
27571,"Idette","Berry","01/01/98"
```

Any `DATE` or `TIMESTAMP` datatypes are converted to strings using the
current `NLS` settings.

## Functions
### QUERY_TO_CSV
This is currently the only function in the package.

#### Syntax
```sql
function query_to_csv(
          p_query in clob
        , p_delimiter in varchar2 default ','
        , p_quote_char in varchar2 default '"'
        , p_escape_char in varchar2 default '"'
        , p_include_headers in boolean default true
        , p_quote_strings in boolean default true
        , p_quote_dates in boolean default true
        , p_end_of_line in varchar2 default chr(13) || chr(10)
    ) return clob;
```
#### Parameters

| Parameter | Description |
| --- | --- |
| p_query | The query to execute |
| p_delimiter | The delimiter used between table columns. For a CSV, this is usually a comma, but a tab-delimited result can be made by using `CHR(9)`. |
| p_quote_char | Strings will be quoted with this character. |
| p_escape_char | If a string contains the quote character, this will escape the quote. For Excel, two double quotes escape one double quote. |
| p_include_headers | If true, the first line of the CSV will be the column names |
| p_quote_strings | If true, strings will be surrounded by this character sequence |
| p_quote_dates | If true, dates will be surrounded by this character sequence, after being converted to a `VARCHAR2`. The CSV generated by sqlcl does not do this, but if the date format contains the delimiter, as in `Month, DD, YYYY`, this can cause problems. |
| p_end_of_line | The character sequence with which to end a line. Defaults to `CRLF` for windows |

## License
Released under the MIT license. Â© Eric Olson, 2025